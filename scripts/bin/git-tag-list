#!/usr/bin/env ruby
# Display the list of current local tags
# Usage :
# $ git-tag-list
# v1.1.2  9242a33  Version 1.1.2
# v1.1.3  7548e9a  Version 1.1.3
# v1.1.4  87967bb  Version 1.1.4

class TagList
  # Return the commit hash for each tag
  def git_tag_hashes
    raw = %x[git show-ref --tags]
    output = {}
    raw.split("\n").each do |line|
      hash, tag = line.split(' ')
      hash = hash[0..7]
      tag.gsub!('refs/tags/', '')
      output[tag] = hash
    end
    return output
  end

  # Return the tag comment for each tag
  def git_tag_comments
    raw = %x[git tag -n | sort -V]
    output = {}
    raw.split("\n").each do |line|
      match = line.match(/(^[^ ]*)\s*(.*)$/)
      tag = match[1]
      comment = match[2]
      output[tag] =  comment
    end
    return output
  end

  def run
    hashes = git_tag_hashes
    comments = git_tag_comments
    tags = comments.keys

    tags.each do |tag|
      puts Tag.new(
        :name => tag,
        :hash => hashes[tag],
        :comment => comments[tag]
      )
    end
  end
end

class Tag
  def initialize(args) 
    @hash = args[:hash]
    @comment = args[:comment]
    @name = args[:name]
  end

  def colorize(text, color)
    color = "%03d" % color
    return "[38;5;#{color}m#{text}[00m"
  end

  def to_s
    name = colorize(@name.ljust(8), 241)
    hash = colorize(@hash, 67)
    comment = colorize(@comment, 250)
    "#{name}  #{hash}  #{comment}"
  end

end

TagList.new().run()

