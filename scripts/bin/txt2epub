#!/usr/bin/env ruby
# encoding : utf-8
require "shellwords"

# Given a txt file, will create the matching epub file, with matching cover

if `which ebook-convert` == ''
	puts "Unable to find ebook-convert, please install calibre"
	exit
end

ARGV.each do |file|
	fullpath = File.expand_path(file)
	ext = File.extname(file)
	basename = File.basename(file)

	next unless ext == '.txt'

	# Create cover
	coverFile = fullpath.gsub(/\.txt$/, '.jpg')
	epubFile = fullpath.gsub(/\.txt$/, '.epub')
	unless File.exists?(coverFile)
		puts "Creating cover"
		%x[ebook-cover-download '#{epubFile}']
	else
		puts "cover already present"
	end

	# Convert to epub
	puts "Converting to epub"
	if File.exists?(epubFile)
		File.rename(epubFile, epubFile+'.bak')
	end

	convertOptions = [
		fullpath.shellescape,
		"'.epub'",
		"--cover #{coverFile.shellescape}",
		"--preserve-cover-aspect-ratio",
		"--formatting-type markdown",
		"--paragraph-type off",
		"--chapter '//h:h2'"
	]
	%x[ebook-convert #{convertOptions.join(' ')}]
end
