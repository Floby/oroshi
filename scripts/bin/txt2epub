#!/usr/bin/env ruby
# encoding : utf-8

# Given a txt file, will create the matching epub file, with matching cover

if `which ebook-convert` == ''
	puts "Unable to find ebook-convert, please install calibre"
	exit
end

ARGV.each do |file|
	fullpath = File.expand_path(file)
	ext = File.extname(file)
	basename = File.basename(file)

	next unless ext == '.txt'

	# Create cover
	epubFile = fullpath.gsub(/\.txt$/, '.epub')
	puts "Creating cover"
	%x[ebook-cover-download '#{epubFile}']
	coverFile = fullpath.gsub(/\.txt$/, '.jpg')

	# Convert to epub
	puts "Converting to epub"
	if File.exists?(epubFile)
		File.rename(epubFile, epubFile+'.bak')
	end
	%x[ebook-convert '#{fullpath}' '.epub' --cover '#{coverFile}' --preserve-cover-aspect-ratio]
end
