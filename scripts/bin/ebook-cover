#!/usr/bin/env ruby
# encoding : utf-8
# Given an ebook file, will fetch its cover

require 'open-uri'

# Need an input
if ARGV.size != 1
	puts "You must specify an ebook"
	exit
end

# Getting developer key
developerKeyFile = File.expand_path('~/.oroshi/private/config/librarything/developerkey')
unless File.exists?(developerKeyFile)
	puts "Unable to find LibraryThing developer key in #{developerKeyFile}"
	exit
end
developerKey = File.read(developerKeyFile).chomp

# Find isbn of book
isbns = %x[ebook-isbn '#{ARGV[0]}']

# Downloading the jpg cover
fullpath = File.expand_path(ARGV[0])
coverFile = fullpath.gsub(/\.epub$/, '.jpg')

if File.exists? coverFile
	puts "Cover already here."
	exit
end

# Testing every ISBN until we find a cover
coverSize = 0
isbns.split("\n").each do |isbn|
	url = "http://covers.librarything.com/devkey/#{developerKey}/large/isbn/#{isbn}"
	puts "Testing to find cover for ISBN #{isbn}"

	distantCover = open(url).read
	next if distantCover.length < 1000
	puts "Found!"

	File.open(coverFile, 'wb') do |file|
		file << distantCover
	end
	break
end

