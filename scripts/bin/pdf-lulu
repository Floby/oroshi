#!/usr/bin/env ruby
require 'fileutils'
require 'shellwords'

# lulu.com asks for PDF to be of a specific format. This script will attempt to
# prepare everything so the manual upload works seamlessly
#
# US Letter size is
# - 8.5" x 11"
# - 21.59cm x 27.94cm
# - 612pt x 792pt
#
# Lulu.com told me that the size of a US Letter, with Bleed box should be of
# - 8.75" x 11.25"
# - 22.22cm x 28.57cm
# They also told me it means adding a margin of
# - 0.25"
# - 0.635cm
# - 18pt
# So I guessed it means adding a margin of 9pt all around
#
# I also want the resulting PDF to bo of 300 dpi (dots per inch), which means
# 8.5" x 300dpi = 2550px
# 11" x 300dpi = 3300px
class PdfLulu
  def initialize(input)
    @input = input

    basename = File.basename(@input, File.extname(@input))
    dirname = File.dirname(@input)
    @directory = File.join(dirname, "#{basename}-lulu")
    FileUtils.mkdir_p(@directory)
  end

  def page_count
    `pdf-pages #{@input.shellescape}`.strip.to_i
  end

  # Split a pdf from `from` to `to`
  def pdf_split(input, from, to, output)
    if from == to
      range = from
    else
      range = "#{from}-#{to}"
    end

    options = [
      input.shellescape,
      'cat',
      range,
      'output',
      output.shellescape
    ]
    `pdftk #{options.join(' ')}`
  end

  def extract_png(page_number, name)
    filepath = File.join(@directory, "#{name}.pdf")
    pngfile = File.join(@directory, "#{name}.png")

    puts "Convert #{name} to pdf"
    pdf_split(@input, page_number, page_number, filepath)

    convert_options = [
      '-flatten',
      '-density 300',
      '-quality 100',
      filepath.shellescape,
      pngfile.shellescape
    ]
    puts "Convert #{name} to png"
    `convert #{convert_options.join(' ')}`

    `rm #{filepath.shellescape}`
  end

  # Extract first and last pages as cover
  def extract_cover
    extract_png(1, 'cover')
    extract_png(page_count, 'back')
  end

  def convert_main
    # Extract only middle pages
    puts 'Extract main part of pdf'
    main_raw = File.join(@directory, 'main_raw.pdf')
    pdf_split(@input, 2, page_count - 1, main_raw)

    # Convert to right size, black and white
    puts 'Convert to right size, black and white'
    main_bw = File.join(@directory, 'main_bw.pdf')
    gs_options = [
      '-sDEVICE=pdfwrite',
      '-dNOPAUSE',
      '-dBATCH',
      '-dPDFFitPage',
      # Dimensions
      '-r300',
      '-g2550x3300',
      '-dPDFSETTINGS=/prepress',
      # Black and white
      '-sColorConversionStrategy=Gray',
      '-dProcessColorModel=/DeviceGray',
      # Remove transparency
      '-dCompatibilityLevel=1.3',
      # Do not take front and back cover
      "-sOutputFile=#{main_bw.shellescape}",
      main_raw.shellescape
    ]
    `gs #{gs_options.join(' ')}`

    # Add margins
    puts 'Add margins and remove links'
    main_margins = File.join(@directory, 'main_margins.pdf')
    `pdfcrop --margins 9 #{main_bw.shellescape} #{main_margins.shellescape}`

    # Flatten transparency
    puts 'Remove transparency'
    main_flattened = File.join(@directory, 'main_flattened.pdf')
    `pdftk #{main_margins.shellescape} output #{main_flattened.shellescape} flatten`

    # Cleanup
    main_final = File.join(@directory, 'main.pdf')
    `rm #{main_raw.shellescape}`
    `rm #{main_bw.shellescape}`
    `rm #{main_margins.shellescape}`
    `mv #{main_flattened.shellescape} #{main_final.shellescape}`
  end

  def run
    extract_cover
    convert_main
  end
end
PdfLulu.new(*ARGV).run
